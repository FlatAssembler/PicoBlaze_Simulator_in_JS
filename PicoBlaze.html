<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PicoBlaze Simulator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="An on-line simulator for Xilinx PicoBlaze, runnable in a modern browser (starting with Firefox 52)."
    />
    <meta name="author" content="Teo Samarzija" />
    <style type="text/css">
      body {
        background-color: #fff7ff;
        background-image: url("Background.gif");
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
      main {
        width: 100%;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        position: absolute;
        top: 65px;
        --lineNumbersWidth: 60px;
      }
      header,
      footer {
        width: 100%;
        text-align: center;
        font-family: Arial;
        line-height: 100%;
      }
      footer {
        max-width: 500px;
        position: absolute;
        top: 1380px;
        left: 50%;
        transform: translate(-50%, 0);
        padding-bottom: 20px;
      }
      h1 {
        margin-bottom: 5px;
      }
      #lineNumbers {
        width: 60px; /*Fallback for browsers which do not support "var".*/
        width: var(--lineNumbersWidth);
        margin-right: 0;
        font-family: Courier New, monospace;
        display: inline-block;
        text-align: right;
        background: #aaaaaa;
        height: 100vh;
        max-height: 400px;
        position: absolute;
        overflow: hidden;
        font-size: 1em;
      }
      #assemblyCode {
        margin: 0;
        width: calc(
          100% - 70px
        ); /* I am not sure breaking compatibility
            * with Firefox 52 (probably the most
            * advanced browser which can run on
            * Windows XP, but it does not support
            * CSS "var" function) is acceptable today.
            */
        width: calc(100% - var(--lineNumbersWidth) - 10px);
        padding-left: 5px;
        font-family: Courier New, monospace;
        text-align: left;
        display: inline-block;
        background: #eeeeee;
        height: 100vh;
        max-height: 400px;
        position: absolute;
        left: 60px;
        left: var(--lineNumbersWidth);
        overflow: scroll;
        white-space: pre;
        font-size: 1em; /* Microsoft Edge seems to have some weird ideas
                         * about how font size should be smaller in <pre>
                         * than in <div>.
                         */
      }
      .comment {
        color: #333333;
        font-style: italic;
      }
      .mnemonic {
        color: #000077;
        font-weight: bold;
      }
      .register {
        color: #773300;
        font-weight: bold;
      }
      #buttons {
        top: 400px;
        position: absolute;
        width: 100%;
      }
      .flag {
        color: #007700;
        font-weight: bold;
      }
      .label {
        color: #770077;
      }
      label {
        display: block;
        font-family: Arial, Helvetica, sans-serif;
        margin-left: 8px;
        margin-top: 3px;
      }
      .string {
        color: #770000;
      }
      .number {
        color: #007777;
      }
      .directive {
        color: #770077;
        font-weight: bold;
      }
      .parenthesis {
        font-weight: bold;
      }
      #highlightButton {
        position: absolute;
        left: 0;
        text-align: left;
        margin-left: 0;
        float: left;
      }
      #assembleButton {
        position: absolute;
        right: 5px;
        text-align: right;
        margin-right: 0;
        float: right;
      }
      #divWithMachineCode {
        position: absolute;
        width: calc(100% - 5px);
        background: white;
        height: 100vh;
        top: 450px;
        overflow: scroll;
        max-height: 400px;
        margin-bottom: 10px;
      }
      #warningAboutJavaScript {
        display: block;
        justify-content: center;
        text-align: center;
        align-items: center;
        height: 100%;
        font-weight: bold;
        font-family: Arial;
        margin-top: auto;
        margin-bottom: auto;
        margin-right: 25px;
        margin-left: 10px;
        max-width: 450px;
      }
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      th {
        font-family: Arial, Sans-Serif;
      }
      td {
        font-family: Courier New, monospace;
        text-align: center;
      }
      td:nth-child(1) {
        text-align: right;
        font-weight: bold;
      }
      #machineCode {
        width: calc(100% - 10px);
        margin: 5px;
      }
      table {
        margin-left: auto;
        margin-right: auto;
        margin-top: 5px;
        margin-bottom: 5px;
      }
      #simulationButtons {
        top: 855px;
        position: absolute;
        width: 100%;
        height: 50px;
        text-align: center;
      }
      #simulationResults {
        top: 910px;
        position: absolute;
        width: calc(100% - 8px);
        height: 100vh;
        max-height: 400px;
        overflow: scroll;
        background-color: white;
        margin-bottom: 15px;
      }
      input {
        width: 30px;
      }
      .regbank_b {
        font-style: italic;
      }
      .active {
        background: white;
        color: black;
      }
      .inactive {
        background: black;
        color: white;
        border-color: white;
      }
      .changed,
      .turning_off {
        background: lightGreen;
        color: black;
        font-weight: bold;
      }
      .turning_off {
        background: red;
      }
      #interrupt_flag {
        font-style: normal;
      }
      .tooltip {
        display: none;
      }
      button:hover .tooltip {
        display: block;
        position: absolute;
        background: #ffffaa;
        z-index: 10;
        padding: 2px;
        font-style: italic;
        font-family: Times;
      }
      .exampleCodeLink {
        margin: 5px;
        width: 120px;
        flex-shrink: 0;
        align-items: center;
        justify-content: center;
        height: 150px;
        background: white;
        text-align: center;
      }
      .exampleCodeLink:hover {
        background: lightGray;
      }
      #divWithExamples {
        background: #ffffee;
        font-family: Arial;
        width: calc(100% - 7px);
        max-width: calc(
          500px - 7px
        ); /* To make the warning about
            * lack of support for modern
            * JavaScript legible in
            * Internet Explorer 11.
            */
        position: absolute;
        top: 405px;
        padding-left: 2px;
      }
      .exampleCodeLink img {
        width: 100px;
        height: 100px;
        margin-left: auto;
        margin-top: 5px;
        margin-right: auto;
        background: white;
      }
      #examples {
        overflow-x: scroll;
        overflow-y: hidden;
        margin: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: gray;
        height: 173px;
      }
      .callForMoreExamples {
        margin: 5px;
      }
      #graphicalResults {
        overflow: scroll;
        position: absolute;
        top: 910px;
        height: 200px;
        width: calc(100% - 5px);
        background: white;
      }
      .sevenSegmentDisplay {
        background: black;
        width: 50px;
        height: 100px;
        margin: 5px;
      }
      .breakpoint_icon {
        display: none;
        width: calc(1em - 3px);
        height: calc(1em - 3px);
      }
      #register_PC {
        font-style: normal;
        /*Otherwise it will turn italic when Regbank B
          is being used, even though it stays active.*/
      }
      button {
        position: relative;
        /*
https://stackoverflow.com/questions/64995585/tooltips-work-in-firefox-but-not-in-chrome
        */
        background: #cccccc; /*WebPositive apparently shows
                               no background on buttons by
                               default.*/
        padding-top: 3px;
        padding-bottom: 1px;
      }
      #downloadHex {
        margin-top: 5px;
        margin-bottom: 5px;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }
      textarea {
        resize: none;
        overflow: scroll;
        width: calc(100% - 3 * 8px - 2px);
        margin-left: calc(2 * 8px);
        height: 95px;
        background-color: black;
        color: aquamarine;
      }
      #UART_IO {
        height: 250px;
        font-size: 1em;
        position: absolute;
        width: calc(100% - 5px);
        overflow: hidden;
        background-color: azure;
        display: none;
      }
      #UART_OUTPUT {
        height: 95px;
        width: calc(100% - 3 * 8px);
        margin-left: calc(2 * 8px);
        overflow: scroll;
        background-color: black;
        color: aquamarine;
        margin-top: auto;
        border-style: solid;
        border-width: 2px;
        border-right-color: lightgray;
        border-bottom-color: lightgray;
        border-top-color: darkgray;
        border-left-color: darkgray;
      }
      #UART_enable_button {
        position: absolute;
        width: calc(100% - 5px);
        font-size: 24px;
        line-height: 36px;
      }
      #fetchingExamples {
        background: white;
        padding: 10px;
        margin: 10px;
      }
    </style>

    <script id="fetchPolyfill"></script>
    <script id="BabelJS"></script>
    <script id="BabelPolyfill"></script>
    <script type="text/javascript">
      "use strict";
      let is_UART_enabled = false,
        areWeHighlighting = false;
      const mnemonics = [
        "ADD",
        "ADDCY",
        "ADDC",
        "AND",
        "CALL",
        "CALL@",
        "COMPARE",
        "COMP",
        "DISABLE",
        "ENABLE",
        "FETCH",
        "INPUT",
        "IN",
        "JUMP",
        "JUMP@",
        "LOAD",
        "OR",
        "OUTPUT",
        "OUT",
        "RETURN",
        "RET",
        "RETURNI",
        "RETI",
        "RL",
        "RR",
        "SL0",
        "SL1",
        "SLA",
        "SLX",
        "SR0",
        "SR1",
        "SRA",
        "SRX",
        "STORE",
        "SUB",
        "SUBCY",
        "SUBC",
        "TEST",
        "XOR",
        "INST",
        "LOAD&RETURN",
        "HWBUILD",
        "STAR",
        "OUTPUTK",
        "REGBANK",
        "TESTCY",
        "TESTC",
        "COMPARECY",
        "COMPCY",
      ];
      const preprocessor = [
        "ADDRESS",
        "ORG",
        "VHDL",
        "EQU",
        "NAMEREG",
        "CONSTANT",
      ];
      let registers = [new Uint8Array(16), new Uint8Array(16)],
        flagZ = [0, 0],
        flagC = [0, 0],
        flagIE = 1,
        output = new Uint8Array(256),
        memory = new Uint8Array(256),
        regbank = 0,
        callStack = [],
        breakpoints = [],
        currentlyReadCharacterInUART = 0;
      let simulationThread;
      function displayRegistersAndFlags() {
        for (let i = 0; i < 2; i++)
          for (let j = 0; j < 16; j++) {
            const tableCell = document.getElementById(
              "register_" +
                String.fromCharCode("A".charCodeAt(0) + i) +
                "_s" +
                j.toString(16)
            );
            if (
              tableCell.innerHTML !== formatAsByte(registers[i][j]) &&
              registers[i][j]
            )
              tableCell.className = "changed";
            else if (tableCell.innerHTML !== formatAsByte(registers[i][j]))
              tableCell.className = "turning_off";
            else if (tableCell.innerHTML === "00")
              tableCell.className = "inactive";
            else tableCell.className = "active";
            tableCell.innerHTML = formatAsByte(registers[i][j]);
          }
        if (
          document.getElementById("flag_A_Z").innerHTML !==
            flagZ[0].toString() &&
          flagZ[0]
        )
          document.getElementById("flag_A_Z").className = "changed";
        else if (
          document.getElementById("flag_A_Z").innerHTML !== flagZ[0].toString()
        )
          document.getElementById("flag_A_Z").className = "turning_off";
        else if (flagZ[0] === 0)
          document.getElementById("flag_A_Z").className = "inactive";
        else document.getElementById("flag_A_Z").className = "active";
        document.getElementById("flag_A_Z").innerHTML = flagZ[0];
        if (
          document.getElementById("flag_B_Z").innerHTML !==
            flagZ[1].toString() &&
          flagZ[1]
        )
          document.getElementById("flag_B_Z").className = "changed";
        else if (
          document.getElementById("flag_B_Z").innerHTML !== flagZ[1].toString()
        )
          document.getElementById("flag_B_Z").className = "turning_off";
        else if (flagZ[1] === 0)
          document.getElementById("flag_B_Z").className = "inactive";
        else document.getElementById("flag_B_Z").className = "active";
        document.getElementById("flag_B_Z").innerHTML = flagZ[1];
        if (
          document.getElementById("flag_A_C").innerHTML !==
            flagC[0].toString() &&
          flagC[0]
        )
          document.getElementById("flag_A_C").className = "changed";
        else if (
          document.getElementById("flag_A_C").innerHTML !== flagC[0].toString()
        )
          document.getElementById("flag_A_C").className = "turning_off";
        else if (flagC[0] === 0)
          document.getElementById("flag_A_C").className = "inactive";
        else document.getElementById("flag_A_C").className = "active";
        document.getElementById("flag_A_C").innerHTML = flagC[0];
        if (
          document.getElementById("flag_B_C").innerHTML !==
            flagC[1].toString() &&
          flagC[1]
        )
          document.getElementById("flag_B_C").className = "changed";
        else if (
          document.getElementById("flag_B_C").innerHTML !== flagC[1].toString()
        )
          document.getElementById("flag_B_C").className = "turning_off";
        else if (flagC[1] === 0)
          document.getElementById("flag_B_C").className = "inactive";
        else document.getElementById("flag_B_C").className = "active";
        document.getElementById("flag_B_C").innerHTML = flagC[1];
        const regbank_a = document.getElementsByClassName("regbank_a");
        const regbank_b = document.getElementsByClassName("regbank_b");
        for (const element of regbank_a)
          element.style.fontStyle = regbank === 0 ? "normal" : "italic";
        for (const element of regbank_b)
          element.style.fontStyle = regbank === 1 ? "normal" : "italic";
        if (
          document.getElementById("interrupt_flag").innerHTML !==
            flagIE.toString() &&
          flagIE
        )
          document.getElementById("interrupt_flag").className = "changed";
        else if (
          document.getElementById("interrupt_flag").innerHTML !==
          flagIE.toString()
        )
          document.getElementById("interrupt_flag").className = "turning_off";
        else if (flagIE === 0)
          document.getElementById("interrupt_flag").className = "inactive";
        else document.getElementById("interrupt_flag").className = "active";
        document.getElementById("interrupt_flag").innerHTML = flagIE;
        document.getElementById("register_PC").innerHTML = formatAsAddress(PC);
      }
      function highlightToken(token) {
        if (token[0] === ";") return `<span class="comment">${token}</span>`;
        for (const mnemonic of mnemonics)
          if (
            RegExp("^" + mnemonic + "$", "i").test(token) ||
            /^interrupt$/i.test(token)
          )
            return `<span class="mnemonic">${token}</span>`;
        for (const directive of preprocessor)
          if (RegExp("^" + directive + "$", "i").test(token))
            return `<span class="directive">${token}</span>`;
        if (/^s(\d|[a-f])$/i.test(token))
          return `<span class="register">${token}</span>`;
        if (/^N?[CZAB]$/i.test(token))
          return `<span class="flag">${token}</span>`;
        if (/:$/.test(token)) return `<span class="label">${token}</span>`;
        if (token[0] === '"') return `<span class="string">${token}</span>`;
        if (
          /^(\d|[a-f])+$/i.test(token) ||
          /\'d$/.test(token) ||
          /\'b$/.test(token)
        )
          return `<span class="number">${token}</span>`;
        return token;
      }
      function syntaxHighlighter(/*edit*/) {
        //"edit" should contain the
        //cursor position, but that
        //seems not to work.
        if (areWeHighlighting) return;
        areWeHighlighting = true;
        const assemblyCodeDiv = document.getElementById("assemblyCode");
        const assemblyCode = assemblyCodeDiv.innerText
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        //const start=edit.selectionStart,
        //  end=edit.selectionEnd; //Cursor position.
        let areWeInAString = false;
        let areWeInAComment = false;
        let currentToken = "";
        let highlightedText = "";
        for (let i = 0; i < assemblyCode.length; i++) {
          if (assemblyCode[i] === ";" && !areWeInAString) {
            highlightedText += highlightToken(currentToken);
            currentToken = ";";
            areWeInAComment = true;
            continue;
          }
          if (areWeInAComment && assemblyCode[i] !== "\n") {
            currentToken += assemblyCode[i];
            continue;
          }
          if (assemblyCode[i] === "\n") {
            areWeInAString = false;
            areWeInAComment = false;
            highlightedText += highlightToken(currentToken) + "<br/>";
            currentToken = "";
            continue;
          }
          if (assemblyCode[i] === ":" && !areWeInAString) {
            highlightedText += highlightToken(currentToken + assemblyCode[i]);
            currentToken = "";
            continue;
          }
          if (
            (assemblyCode[i] === " " ||
              assemblyCode[i] === "\t" ||
              assemblyCode[i] === "," ||
              assemblyCode[i] === "+" ||
              assemblyCode[i] === "-" ||
              assemblyCode[i] === "*" ||
              assemblyCode[i] === "/" ||
              assemblyCode[i] === "^") &&
            !areWeInAString
          ) {
            highlightedText += highlightToken(currentToken) + assemblyCode[i];
            currentToken = "";
            continue;
          }
          if (assemblyCode[i] === '"' && !areWeInAString) {
            highlightedText += highlightToken(currentToken);
            currentToken = '"';
            areWeInAString = true;
            continue;
          }
          if (
            (assemblyCode[i] === "(" ||
              assemblyCode[i] === ")" ||
              assemblyCode[i] === "[" ||
              assemblyCode[i] === "]" ||
              assemblyCode[i] === "{" ||
              assemblyCode[i] === "}") &&
            !areWeInAString
          ) {
            highlightedText +=
              highlightToken(currentToken) +
              '<span class="parenthesis">' +
              assemblyCode[i] +
              "</span>";
            currentToken = "";
            continue;
          }
          if (assemblyCode[i] !== '"') {
            currentToken += assemblyCode[i];
            continue;
          }
          if (assemblyCode[i] === '"' && areWeInAString) {
            highlightedText += highlightToken(currentToken + '"');
            currentToken = "";
            areWeInAString = false;
          }
        }
        highlightedText += highlightToken(currentToken);
        assemblyCodeDiv.innerHTML = highlightedText;
        //The following code is supposed to move the cursor to the correct
        //position, but it doesn't work.
        /*
        const range=document.createRange();
        range.setStart(assemblyCodeDiv,start);
        range.setEnd(assemblyCodeDiv,end);
        const selection=window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        */
        setUpLineNumbers();
        areWeHighlighting = false;
      }
      function setUpLineNumbers() {
        const assemblyCode = document.getElementById("assemblyCode").innerText;
        const numberOfLines = Math.max(
          (assemblyCode.match(/\n/g) || []).length,
          1
        );
        let lineNumbersHTML = "";
        for (let i = 1; i <= numberOfLines; i++)
          lineNumbersHTML +=
            '<div id="label_line_' +
            i +
            '" data-linenumber="' +
            i +
            '"><img src="breakpoint.png" alt="BP" id="breakpoint_icon_' +
            i +
            '" class="breakpoint_icon"/>' +
            i +
            ".</div>";
        document.getElementById("lineNumbers").innerHTML = lineNumbersHTML;
        for (let i = 1; i <= numberOfLines; i++)
          document.getElementById("label_line_" + i).onclick = setBreakpoint;
        for (let i = 0; i < breakpoints.length; i++)
          if (breakpoints[i] <= numberOfLines)
            document.getElementById(
              "breakpoint_icon_" + breakpoints[i]
            ).style.display = "inline";
          else {
            breakpoints.splice(i, 1);
            i--;
          }
      }
      function setBreakpoint(event) {
        const lineNumber = parseInt(
          event.currentTarget.getAttribute("data-linenumber")
        );
        console.log("Setting/removing breakpoint on line #" + lineNumber + ".");
        if (breakpoints.includes(lineNumber))
          breakpoints.splice(breakpoints.indexOf(lineNumber), 1);
        else breakpoints.push(lineNumber);
        if (breakpoints.includes(lineNumber))
          document.getElementById(
            "breakpoint_icon_" + lineNumber
          ).style.display = "inline";
        else
          document.getElementById(
            "breakpoint_icon_" + lineNumber
          ).style.display = "none";
      }
      function setupLayout() {
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        //Modern browsers execute
        //JavaScript so fast that
        //calling "window.innerWidth"
        //multiple times within a
        //function leads to a race
        //condition.
        if (windowWidth < 500)
          document.getElementsByTagName("main")[0].style.left = 8 + "px";
        else
          document.getElementsByTagName("main")[0].style.left =
            windowWidth / 2 - 500 / 2 + "px";
        if (windowHeight < 400) {
          document.getElementById("buttons").style.top =
            windowHeight + 200 + 3 * 4 + "px";
          document.getElementById("divWithMachineCode").style.top =
            windowHeight + 4 * 4 + 20 + 200 + "px";
          document.getElementById("simulationButtons").style.top =
            2 * windowHeight + 3 * 4 + 30 + 200 + "px";
          document.getElementsByTagName("footer")[0].style.top =
            65 +
            4 +
            2 * 50 +
            3 * windowHeight +
            200 +
            210 +
            is_UART_enabled * 260 +
            50 +
            "px";
          document.getElementById("divWithExamples").style.top =
            windowHeight + 4 + "px";
          document.getElementById("simulationResults").style.top =
            windowHeight * 2 +
            200 +
            65 +
            50 -
            30 +
            210 +
            is_UART_enabled * 260 +
            50 +
            "px";
          document.getElementById("graphicalResults").style.top =
            windowHeight * 2 + 200 + 65 + 50 - 30 + "px";
          document.getElementById("UART_enable_button").style.top =
            windowHeight * 2 + 200 + 65 + 50 - 30 + 210 + "px"; //Usually has no effect, see below...
          document.getElementById("UART_IO").style.top =
            windowHeight * 2 + 200 + 65 + 50 - 30 + 210 + 50 + "px";
        } else {
          document.getElementById("divWithExamples").style.top = 410 + "px";
          document.getElementById("buttons").style.top =
            400 + 210 + 3 * 4 + "px";
          document.getElementById("divWithMachineCode").style.top =
            450 + 210 + "px";
          document.getElementById("simulationButtons").style.top =
            855 + 210 + "px";
          document.getElementById("simulationResults").style.top =
            910 + 2 * 210 + is_UART_enabled * 260 + 50 + "px";
          document.getElementById("UART_IO").style.top =
            910 + 2 * 210 + 50 + "px"; //Has no effect if the UART_IO is not shown (and it isn't shown by default).
          document.getElementById("UART_enable_button").style.top =
            910 + 2 * 210 + "px";
          document.getElementById("graphicalResults").style.top =
            910 + 210 + "px";
          document.getElementsByTagName("footer")[0].style.top =
            1380 + 2 * 210 + is_UART_enabled * 260 + 50 + "px";
        }
      }
      let machineCode = [];
      for (let i = 0; i < 4096; i++)
        machineCode.push({ hex: "00000", line: 0 });
      let PC = 0;
      function formatAsAddress(n) {
        let ret = Math.round(n).toString(16);
        if (Math.round(n) >= 4096 || Math.round(n) < 0) {
          alert(
            "Some part of the compiler tried to format the number " +
              n +
              " as an address, which makes no sense."
          );
          return "fff";
        }
        while (ret.length < 3) ret = "0" + ret;
        return ret;
      }
      function drawTable() {
        let tableHTML = `
        <button id="downloadHex">Download Hexadecimal</button>
        <table id="machineCode">
           <tr>
             <th colspan="4">Machine Code</th>
           </tr>
           <tr>
             <th>PC</th>
             <th>Address</th>
             <th>Directive</th>
             <th>Line</th>
           </tr>
        `;
        for (let i = 0; i < machineCode.length; i++)
          tableHTML += `
            <tr>
              <td id="PC_label_${formatAsAddress(i)}">${
            PC === i ? "-&gt;" : " "
          }</td>
              <td>${formatAsAddress(i)}</td>
              <td>${machineCode[i].hex}</td>
              <td>${machineCode[i].line}</td>
            </tr>
          `;
        tableHTML += "</table>";
        document.getElementById("divWithMachineCode").innerHTML = tableHTML;
        let registersTable = `
<table style="font-size:0.95em;">
  <tr>
    <th>Registers</th>
        `;
        for (let i = 0; i < 16; i++)
          registersTable += "<th>s" + i.toString(16) + "</th>";
        registersTable += "<th>PC</th>";
        registersTable += '</tr><tr class="regbank_a"><th>REGBANK A</th>';
        for (let i = 0; i < 16; i++)
          registersTable +=
            '<td id="register_A_s' + i.toString(16) + '">00</td>';
        registersTable +=
          '<td id="register_PC" rowspan=2>000</td></tr><tr class="regbank_b"><th>REGBANK B</th>';
        for (let i = 0; i < 16; i++)
          registersTable +=
            '<td id="register_B_s' + i.toString(16) + '">00</td>';
        registersTable += "</tr></table>";
        let flagsTable = `
        <table>
          <tr>
            <th>Flags</th>
            <th>Zero (Z)</th>
            <th>Carry (C)</th>
            <th>Interrupt Enabled (IE)</th>
          </tr>
          <tr class="regbank_a">
            <th>REGBANK A</th>
            <td id="flag_A_Z">0</td>
            <td id="flag_A_C">0</td>
            <td id="interrupt_flag" rowspan="2">1</td>
          </tr>
          <tr class="regbank_b">
            <th>REGBANK B</th>
            <td id="flag_B_Z">0</td>
            <td id="flag_B_C">0</td>
          </tr>
        </table>
        <div style="text-align: center; font-family: Arial;">
        <b style="background: #FF7777; padding-left: 2px; padding-right:2px;">
        NOTE</b>:
        I have good reasons to think the emulation of flags is unrealistic,
        especially when it comes to <code>REGBANK</code>s.</div>`;
        let inputOutputTable = `
<table>
  <tr>
    <th>Address</th>
    <th>Input</th>
    <th>Output</th>
    <th>Memory</th>
  </tr>
        `;
        for (let i = 0; i < 256; i++)
          inputOutputTable +=
            "<tr><th>" +
            formatAsByte(i) +
            '</th><td><input id="input_' +
            formatAsByte(i) +
            '" value="00"></td><td id="output_' +
            formatAsByte(i) +
            '">00</td><td id="memory_' +
            formatAsByte(i) +
            '">00</td></tr>';
        inputOutputTable += "</table>";
        let oldOnInput, oldInput00Value;
        if (document.getElementById("input_00")) {
          oldOnInput = document.getElementById("input_00").oninput;
          oldInput00Value = document.getElementById("input_00").value;
        }
        document.getElementById("simulationResults").innerHTML =
          registersTable + flagsTable + inputOutputTable;
        document.getElementById("input_00").oninput = oldOnInput;
        if (
          document.getElementById("input_00") &&
          typeof document.getElementById("input_00").oninput === "function"
        ) {
          document.getElementById("input_00").value = oldInput00Value;
          //Because, on real PicoBlaze, switches do not automatically switch
          //to 0 when assembling is done.
          document.getElementById("input_00").oninput();
        }
        document.getElementById("downloadHex").onclick = downloadHex;
        document.getElementById("input_02").disabled = document.getElementById(
          "input_03"
        ).disabled = is_UART_enabled;
      }
      function downloadHex() {
        /*
        Loosely based on:
        https://stackoverflow.com/a/33622881/8902065
        */
        let hexadecimalString = "";
        for (let i = 0; i < 2 ** 12; i++)
          hexadecimalString += machineCode[i].hex + "\r\n";
        let arrayOfBytes = new Uint8Array(hexadecimalString.length);
        for (let i = 0; i < hexadecimalString.length; i++)
          arrayOfBytes[i] = hexadecimalString.charCodeAt(i);
        const blob = new Blob([arrayOfBytes], {
          type: "application/binhex",
          endings: "transparent",
        });
        const url = URL.createObjectURL(blob);
        let link = document.createElement("a");
        link.href = url;
        link.download = "program.hex";
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        link.remove();
      }
      function displayOutput() {
        for (let i = 0; i < 2 ** 8; i++)
          document.getElementById("output_" + formatAsByte(i)).innerHTML =
            formatAsByte(output[i]);
        displayHexadecimalNumber(
          document.getElementById("sevenSegmentDisplay0"),
          output[1] >> 4
        );
        displayHexadecimalNumber(
          document.getElementById("sevenSegmentDisplay1"),
          output[1] % 2 ** 4
        );
        displayHexadecimalNumber(
          document.getElementById("sevenSegmentDisplay2"),
          output[2] >> 4
        );
        displayHexadecimalNumber(
          document.getElementById("sevenSegmentDisplay3"),
          output[2] % 2 ** 4
        );
        for (let i = 0; i < 8; i++)
          document
            .getElementById("LED" + i)
            .setAttribute(
              "fill",
              output[0] & (1 << i) ? "lightGreen" : "#333333"
            );
      }
      function displayHexadecimalNumber(display, number) {
        if (
          !(display instanceof SVGElement) ||
          display.classList[0] !== "sevenSegmentDisplay"
        ) {
          if (playing) clearInterval(simulationThread);
          alert(
            "The simulator crashed! Some part of the simulator attempted to display a hexadecmal number on something that's not an HTML element suited for that."
          );
          return;
        }
        if (number < 0 || number > 15 || typeof number !== "number") {
          if (playing) clearInterval(simulationThread);
          alert(
            'The simulator crashed! Some part of the simulator tried to display "' +
              number +
              '" as a hexadecimal digit.'
          );
        }
        number = Math.floor(number);
        const LEDs = [
          "1111110", // 0
          "0110000", // 1
          "1101101", // 2
          "1111001", // 3
          "0110011", // 4
          "1011011", // 5
          "1011111", // 6
          "1110000", // 7
          "1111111", // 8
          "1111011", // 9
          "1110111", // A
          "0011111", // b
          "1001110", // c
          "0111101", // d
          "1001111", // E
          "1000111", // F
        ];
        const LED = LEDs[number];
        for (let i = 0; i < display.children.length; i++)
          display.children[i].setAttribute(
            "fill",
            LED[i] === "0" ? "#333333" : "#ffaaaa"
          );
      }
      function fetchExample(exampleName) {
        document.getElementById("assemblyCode").innerHTML =
          ";Fetching the example from GitHub...";
        setUpLineNumbers();
        fetch(
          "https://raw.githubusercontent.com/FlatAssembler/PicoBlaze_Simulator_in_JS/master/" +
            exampleName
        )
          .then((response) => {
            if (!response.ok) throw new Error(response.status);
            else return response.text();
          })
          .then((text) => {
            document.getElementById("assemblyCode").innerHTML = text;
            setUpLineNumbers();
          })
          .catch((error) =>
            alert(
              "Fetching the example code from GitHub unsuccessful! " + error
            )
          );
      }
    </script>
    <script src="TreeNode.js" type="text/javascript"></script>
    <script src="tokenizer.js" type="text/javascript"></script>
    <script src="parser.js" type="text/javascript"></script>
    <script src="preprocessor.js" type="text/javascript"></script>
    <script src="assembler.js" type="text/javascript"></script>
    <script src="simulator.js" type="text/javascript"></script>
  </head>
  <body>
    <header>
      <h1>PicoBlaze Simulator</h1>
      Made by Teo Samar&#382;ija.
    </header>
    <main>
      <div id="lineNumbers">1.</div>
      <pre id="assemblyCode" contenteditable="true">
;Insert PicoBlaze assembly here...
</pre
      >
      <div id="divWithExamples">
        <span id="examplesSpan">Examples:</span>
        <div id="examples">
          <span id="fetchingExamples">
            Fetching the examples from GitHub...
          </span>
        </div>
      </div>
      <div id="buttons">
        <button id="highlightButton">Highlight Assembly</button>
        <button id="assembleButton">Assemble</button>
      </div>
      <div id="divWithMachineCode">
        <div id="warningAboutJavaScript">
          Your browser doesn't seem to support modern JavaScript, needed for
          this web-app!<br />
          I would recommend you to use
          <a href="https://www.torproject.org/">The TOR Browser</a>. Modern
          JavaScript executes the fastest in it, as fast as in
          <a href="https://www.mozilla.org/en-US/">Firefox</a>, but TOR Browser
          protects privacy significantly more.<br />Please consider that, if too
          few people use tools for protecting privacy on the Internet, using
          them is considered suspicious. Participating in a system that does not
          respect privacy is putting everybody in danger of mass surveillance
          and predictive policing. Even if you think you have nothing to hide,
          please think of others (and learn about senseless laws and red flags
          that apply to you).<br />
          My
          <a href="https://flatassembler.github.io/compiler.html"
            >web-app that converts arithmetic expressions to x86 assembly</a
          >
          can run in ancient browsers, in case you want to try it.<br />
          Or, you can try
          <a href="javascript:void(0)" onclick="downloadBabel()"
            >polyfilling your browser with BabelJS</a
          >.
        </div>
      </div>
      <script>
        function downloadBabel() {
          var scripts = document.getElementsByTagName("script");
          for (var i = 0; i < scripts.length; i++) {
            if (scripts[i].type == "text/javascript")
              scripts[i].type = "text/babel";
          }
          document.getElementById("BabelPolyfill").src =
            "https://unpkg.com/@babel/polyfill/dist/polyfill.js";
          /*
	       Do not include the minified file, because Babel Minifier
	       transpiles "RegExp('x','y')" into "/x/y", which is a syntax
	       error in Internet Explorer 11!
	    */
          document.getElementById("BabelJS").src =
            "https://unpkg.com/@babel/standalone/babel.min.js";
          document.getElementById("fetchPolyfill").src =
            "https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js";
        }
      </script>
      <div id="simulationButtons">
        <button id="playPauseButton">
          <img
            src="play.svg"
            alt="play"
            id="playImage"
            style="display: inline"
          />
          <img
            src="pause.svg"
            alt="pause"
            id="pauseImage"
            style="display: none"
          />
          <span class="tooltip">Play/Pause</span>
          <!--Didn't know modern browsers don't display alts automatically
              when you hover over an image.-->
        </button>
        <button id="fastForwardButton">
          <img src="fastForward.svg" alt="Fast Forward" />
          <span class="tooltip">Fast Forward</span>
        </button>
        <button id="singleStepButton">
          <img src="singleStep.svg" alt="Single Step" />
          <span class="tooltip">Single Step</span>
        </button>
        <button id="stopButton">
          <svg width="30" height="30" alt="stop">
            <defs>
              <radialGradient id="redGradient">
                <stop offset="0%" stop-color="rgb(64,0,0)" />
                <stop offset="75%" stop-color="black" />
              </radialGradient>
            </defs>
            <polygon points="0,0 30,0 30,30 0,30" fill="url(#redGradient)" />
          </svg>
          <span class="tooltip">Stop</span>
        </button>
      </div>
      <div id="graphicalResults"></div>
      <button id="UART_enable_button">
        <span id="enable_or_disable_UART">Enable</span>
        <abbr title="Universal Asynchronous Receiver-Transmitter">UART</abbr>
        terminal
      </button>
      <div id="UART_IO">
        <label for="UART_INPUT"
          >UART input (<i>enter <b>before</b> starting</i>):</label
        >
        <textarea id="UART_INPUT"></textarea>
        <label for="UART_OUTPUT">UART output:</label>
        <pre id="UART_OUTPUT"></pre>
      </div>
      <div id="simulationResults"></div>
    </main>
    <footer>
      Not affiliated with
      <a
        href="https://www.xilinx.com/products/intellectual-property/picoblaze.html"
        >PicoBlaze</a
      >. If you want to contribute,
      <a href="https://github.com/FlatAssembler/PicoBlaze_Simulator_in_JS"
        >fork me on GitHub</a
      >. Exceptionally helpful would be contributions to
      <a href="https://github.com/FlatAssembler/PicoBlaze_Simulator_for_Android"
        >the Android version of this simulator</a
      >, as I am not an experienced Android developer. If you would like to know
      more about me, visit my
      <a href="https://flatassembler.github.io/">homepage</a>. The documentation
      for this simulator is available in
      <a href="PicoBlaze.rtf">this <abbr title="Rich Text Format">RTF</abbr></a>
      (saved from <a href="https://www.libreoffice.org/">LibreOffice</a>, some
      other formats are available on GitHub as well). For now, the documentation
      is only available in Croatian. If you are willing to spend your time
      translating it to English (better than machine translation), contact me on
      GitHub.
    </footer>
    <script type="text/javascript">
      "use strict";
      //For now, attempting to highlight code as the user is typing is worse
      //than useless, because it moves the cursor to the beginning.
      /*
    document.getElementById("assemblyCode").
             oninput=syntaxHighlighter;
    */
      setUpLineNumbers();
      document.getElementById("assemblyCode").oninput = setUpLineNumbers;
      document.getElementById("assemblyCode").onscroll = () => {
        document
          .getElementById("lineNumbers")
          .scroll(0, document.getElementById("assemblyCode").scrollTop);
      };
      document.getElementById("highlightButton").onclick = syntaxHighlighter;
      document.getElementById("assembleButton").onclick = () => {
        const assembly = document.getElementById("assemblyCode").innerText;

        let tokenized;
        try {
          tokenized = tokenize(assembly);
        } catch (error) {
          alert("Internal compiler error in the tokenizer: " + error.message);
          return;
        }
        let resultOfTokenizing = "[";
        for (let i = 0; i < tokenized.length; i++) {
          const token = tokenized[i];
          if (token.text === "\n") resultOfTokenizing += '"\\n"';
          else resultOfTokenizing += '"' + token.text + '"';
          if (i !== tokenized.length - 1) resultOfTokenizing += ",";
        }
        resultOfTokenizing += "]";
        console.log("Result of tokenizing: ", resultOfTokenizing);
        let parsed;
        try {
          parsed = parse(tokenized);
        } catch (error) {
          alert("Internal compiler error in the parser: " + error.message);
        }
        console.log("Result of parsing: ", parsed.getLispExpression());
        let context;
        try {
          context = makeCompilationContext(parsed);
        } catch (error) {
          alert(
            "Internal compiler error in the preprocessor: " + error.message
          );
        }
        console.log("Result of preprocessing: ", context);
        try {
          assemble(parsed, context);
        } catch (error) {
          alert("Internal assembler error: " + error.message);
        }
        drawTable();
        stopSimulation();
      };
      function stopSimulation() {
        document.getElementById("fastForwardButton").disabled = false;
        document.getElementById("singleStepButton").disabled = false;
        document.getElementById("UART_INPUT").disabled = false;
        if (playing) clearInterval(simulationThread);
        document.getElementById("PC_label_" + formatAsAddress(PC)).innerHTML =
          "";
        PC = 0;
        document.getElementById("PC_label_000").innerHTML = "-&gt;";
        playing = false;
        document.getElementById("playImage").style.display = "inline";
        document.getElementById("pauseImage").style.display = "none";
        for (let i = 0; i < 256; i++) output[i] = 0;
        for (let i = 0; i < 16; i++) registers[0][i] = registers[1][i] = 0;
        flagZ = [0, 0];
        flagC = [0, 0];
        callStack = [];
        regbank = 0;
        flagIE = 1;
        displayRegistersAndFlags();
        displayOutput();
        currentlyReadCharacterInUART = 0;
      }
      setupLayout();
      window.onresize = setupLayout;
      drawTable();
      displayRegistersAndFlags();
      let playing = false;
      function onPlayPauseButton() {
        playing = !playing;
        if (!playing) {
          clearInterval(simulationThread);
          document.getElementById("fastForwardButton").disabled = false;
          document.getElementById("singleStepButton").disabled = false;
          document.getElementById("UART_INPUT").disabled = false;
          document.getElementById("playImage").style.display = "inline";
          document.getElementById("pauseImage").style.display = "none";
        } else {
          simulationThread = setInterval(simulateOneInstruction, 500);
          document.getElementById("fastForwardButton").disabled = true;
          document.getElementById("singleStepButton").disabled = true;
          document.getElementById("UART_INPUT").disabled = true;
          document.getElementById("playImage").style.display = "none";
          document.getElementById("pauseImage").style.display = "inline";
        }
      }
      function onSingleStepButton() {
        if (playing) return;
        simulateOneInstruction();
      }
      function fastForward() {
        playing = true;
        document.getElementById("fastForwardButton").disabled = true;
        document.getElementById("singleStepButton").disabled = true;
        document.getElementById("UART_INPUT").disabled = true;
        simulationThread = setInterval(simulateOneInstruction, 0);
        document.getElementById("playImage").style.display = "none";
        document.getElementById("pauseImage").style.display = "inline";
      }
      document.getElementById("playPauseButton").onclick = onPlayPauseButton;
      document.getElementById("stopButton").onclick = stopSimulation;
      document.getElementById("singleStepButton").onclick = onSingleStepButton;
      document.getElementById("fastForwardButton").onclick = fastForward;
      const svgNS =
        document.getElementById("stopButton").children[0].namespaceURI;
      let sevenSegmentDisplays = document.createElement("div");
      sevenSegmentDisplays.style.width = 4 * 60 + "px";
      sevenSegmentDisplays.style.marginLeft = "auto";
      sevenSegmentDisplays.style.marginRight = "auto";
      for (let i = 0; i < 4; i++) {
        let sevenSegmentDisplay = document.createElementNS(svgNS, "svg");
        sevenSegmentDisplay.classList.add("sevenSegmentDisplay");
        sevenSegmentDisplay.id = "sevenSegmentDisplay" + i;
        const polygons = [
          "15,5  35, 5 40,10 35,15 15,15 10,10", //Segment A (top)
          "40,10 45,15 45,45 40,50 35,45 35,15", //Segment B (top-right)
          "40,50 45,55 45,85 40,90 35,85 35,55", //Segment C (bottom-right)
          "40,90 35,95 15,95 10,90 15,85 35,85", //Segment D (bottom)
          "10,90  5,85  5,55 10,50 15,55 15,85", //Segment E (bottom-left)
          "10,50  5,45  5,15 10,10 15,15 15,45", //Segment F (top-left)
          "10,50 15,45 35,45 40,50 35,55 15,55", //Segment G (hyphen in the middle)
        ];
        for (const polygonPoints of polygons) {
          let polygon = document.createElementNS(svgNS, "polygon");
          if (polygons.indexOf(polygonPoints) === 6)
            polygon.setAttribute("fill", "#ffaaaa");
          else polygon.setAttribute("fill", "#333333");
          polygon.setAttribute("points", polygonPoints);
          polygon.setAttribute("stroke", "black");
          sevenSegmentDisplay.appendChild(polygon);
        }
        sevenSegmentDisplays.appendChild(sevenSegmentDisplay);
      }
      document
        .getElementById("graphicalResults")
        .appendChild(sevenSegmentDisplays);
      let LEDs = document.createElementNS(svgNS, "svg");
      LEDs.setAttribute("width", 400);
      LEDs.setAttribute("height", 60);
      LEDs.style.background = "darkGreen"; //"fill" does not work here.
      LEDs.style.marginLeft = "auto"; //No idea why this is necessary.
      LEDs.style.marginRight = "auto";
      LEDs.style.display = "block";
      for (let i = 0; i < 8; i++) {
        let LED = document.createElementNS(svgNS, "circle");
        LED.setAttribute("fill", "#333333");
        LED.setAttribute("cx", 25 + i * 50);
        LED.setAttribute("cy", 15);
        LED.setAttribute("r", 5);
        LED.id = "LED" + (7 - i);
        LEDs.appendChild(LED);
        let switchHolder = document.createElementNS(svgNS, "rect");
        switchHolder.setAttribute("fill", "black");
        switchHolder.setAttribute("width", 5);
        switchHolder.setAttribute("height", 30);
        switchHolder.setAttribute("y", 25);
        switchHolder.setAttribute("x", 23 + i * 50);
        LEDs.appendChild(switchHolder);
        let button = document.createElementNS(svgNS, "rect");
        button.setAttribute("fill", "gray");
        button.setAttribute("width", 15);
        button.setAttribute("height", 15);
        button.setAttribute("x", 18 + i * 50);
        button.setAttribute("y", 25 + 30 - 15);
        button.id = "switch" + i;
        button.setAttribute("data-buttonValue", 1 << (7 - i));
        button.onclick = onSwitchPressed;
        LEDs.appendChild(button);
      }
      document.getElementById("graphicalResults").appendChild(LEDs);
      function onSwitchPressed(event) {
        let valueOfTheFirstInput = parseInt(
          document.getElementById("input_00").value,
          16
        );
        valueOfTheFirstInput ^= event.target.getAttribute("data-buttonValue");
        if (
          valueOfTheFirstInput &
          /* bitwise and (not a typo) */ event.target.getAttribute(
            "data-buttonValue"
          )
        )
          event.target.setAttribute("y", 25);
        else event.target.setAttribute("y", 25 + 30 - 15);
        document.getElementById("input_00").value =
          formatAsByte(valueOfTheFirstInput);
      }
      document.getElementById("input_00").oninput = () => {
        const value =
          Math.abs(
            parseInt(document.getElementById("input_00").value, 16) | 0
          ) % 256;
        let formatedAsBinary = value.toString(2);
        while (formatedAsBinary.length < 8)
          formatedAsBinary = "0" + formatedAsBinary;
        for (let i = 0; i < 8; i++)
          document
            .getElementById("switch" + i)
            .setAttribute("y", 40 - formatedAsBinary[i] * 15);
      };
      document.getElementById("UART_enable_button").onclick = () => {
        is_UART_enabled = !is_UART_enabled;
        document.getElementById("input_02").disabled = document.getElementById(
          "input_03"
        ).disabled = is_UART_enabled;
        document.getElementById("UART_IO").style.display = is_UART_enabled
          ? "block"
          : "none";
        document.getElementById("enable_or_disable_UART").innerHTML =
          is_UART_enabled ? "Disable" : "Enable";
        window.onresize();
      };
      fetch("https://flatassembler.github.io/PicoBlaze/examples.json")
        .then((response) => {
          if (!response.ok) throw new Error(response.status);
          else return response.text();
        })
        .then((jsonFromGithub) => {
          const examplesArray = JSON.parse(jsonFromGithub);
          let examplesHTML =
            examplesArray
              .map(
                (example) => `
          <div class="exampleCodeLink" onclick="fetchExample('${example.file_name}')">
            <img
              src="${example.image}"
              alt="${example.image_alt}"
            />${example.name}
          </div>
              `
              )
              .join("") +
            `
          <div class="exampleCodeLink" style="display: flex">
            <div class="callForMoreExamples">
            Maybe you'd like to try <a href="https://flatassembler.github.io/Duktape.zip">my examples of x86 assembly</a>,
            that <a href="https://flatassembler.github.io/AEC_specification.html#HowToCompile">AEC compiles</a> to?
            </div>
          </div>
          <div class="exampleCodeLink" style="display: flex">
            <div class="callForMoreExamples">
              Have some example you would like to add here?
              <a
                href="https://github.com/FlatAssembler/PicoBlaze_Simulator_in_JS/issues"
                >Contact me on GitHub</a
              >!
            </div>
          </div>
          <div style="width: 1px; flex-shrink: 0">
            <!--
                Because, apparently, CSS ignores the right-margin on flex
                elements that cause overflow.
           -->
          </div>            
            `;
          document.getElementById("examples").style.justifyContent = "initial";
          document.getElementById("examples").style.alignItems = "initial";
          document.getElementById("examples").innerHTML = examplesHTML;
        })
        .catch((error) => {
          document.getElementById("fetchingExamples").innerHTML =
            "Failed to fetch the examples JSON from GitHub: " + error;
        });
    </script>
  </body>
</html>
