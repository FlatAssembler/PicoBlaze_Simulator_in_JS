<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PicoBlaze Simulator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style type="text/css">
      body {
        background-color: #fff7ff;
        background-image: url("Background.gif");
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
      main {
        width: 100%;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        position: absolute;
        top: 65px;
      }
      header,
      footer {
        width: 100%;
        text-align: center;
        font-family: Arial;
        line-height: 100%;
      }
      footer {
        max-width: 500px;
        position: absolute;
        top: 1380px;
        left: 50%;
        height: 75px;
        transform: translate(-50%, 0);
      }
      h1 {
        margin-bottom: 5px;
      }
      #lineNumbers {
        width: 40px;
        margin-right: 0;
        font-family: Courier New, monospace;
        display: inline-block;
        text-align: right;
        background: #aaaaaa;
        height: 100vh;
        max-height: 400px;
        position: absolute;
        overflow: hidden;
        font-size: 1em;
      }
      #assemblyCode {
        margin: 0;
        width: calc(100% - 45px - 5px);
        padding-left: 5px;
        font-family: Courier New, monospace;
        text-align: left;
        display: inline-block;
        background: #eeeeee;
        height: 100vh;
        max-height: 400px;
        position: absolute;
        left: 40px;
        overflow: scroll;
        white-space: pre;
        font-size: 1em; /* Microsoft Edge seems to have some weird ideas
                         * about how font size should be smaller in <pre>
                         * than in <div>.
                         */
      }
      .comment {
        color: #333333;
        font-style: italic;
      }
      .mnemonic {
        color: #000077;
        font-weight: bold;
      }
      .register {
        color: #773300;
        font-weight: bold;
      }
      #buttons {
        top: 400px;
        position: absolute;
        width: 100%;
      }
      .flag {
        color: #007700;
        font-weight: bold;
      }
      .label {
        color: #770077;
      }
      .string {
        color: #770000;
      }
      .number {
        color: #007777;
      }
      .directive {
        color: #770077;
        font-weight: bold;
      }
      .parenthesis {
        font-weight: bold;
      }
      #highlightButton {
        position: absolute;
        left: 0;
        text-align: left;
        margin-left: 0;
        float: left;
      }
      #assembleButton {
        position: absolute;
        right: 5px;
        text-align: right;
        margin-right: 0;
        float: right;
      }
      #divWithMachineCode {
        position: absolute;
        width: calc(100% - 5px);
        background: white;
        height: 100vh;
        top: 450px;
        overflow: scroll;
        max-height: 400px;
        margin-bottom: 10px;
      }
      #warningAboutJavaScript {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        font-weight: bold;
        font-family: Arial;
      }
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      th {
        font-family: Arial, Sans-Serif;
      }
      td {
        font-family: Courier New, monospace;
        text-align: center;
      }
      td:nth-child(1) {
        text-align: right;
        font-weight: bold;
      }
      #machineCode {
        width: calc(100% - 10px);
        margin: 5px;
      }
      table {
        margin-left: auto;
        margin-right: auto;
        margin-top: 5px;
        margin-bottom: 5px;
      }
      #simulationButtons {
        top: 855px;
        position: absolute;
        width: 100%;
        height: 50px;
        text-align: center;
      }
      #simulationResults {
        top: 910px;
        position: absolute;
        width: calc(100% - 8px);
        height: 100vh;
        max-height: 400px;
        overflow: scroll;
        background-color: white;
        margin-bottom: 15px;
      }
      input {
        width: 30px;
      }
      .regbank_b {
        font-style: italic;
      }
      .active {
        background: white;
        color: black;
      }
      .inactive {
        background: black;
        color: white;
        border-color: white;
      }
      .changed,
      .turning_off {
        background: lightGreen;
        color: black;
        font-weight: bold;
      }
      .turning_off {
        background: red;
      }
      #interrupt_flag {
        font-style: normal;
      }
      .tooltip {
        display: none;
      }
      button:hover .tooltip {
        display: block;
        position: absolute;
        background: #ffffaa;
        z-index: 10;
        padding: 2px;
        font-style: italic;
        font-family: Times;
      }
      .exampleCodeLink {
        position: absolute;
        margin: 5px;
        width: 120px;
        height: 150px;
        background: white;
        text-align: center;
      }
      .exampleCodeLink:hover {
        background: lightGray;
      }
      #divWithExamples {
        background: white;
        font-family: Arial;
        width: calc(100% - 5px);
        position: absolute;
        top: 405px;
      }
      .exampleCodeLink img {
        width: 100px;
        height: 100px;
        margin-left: auto;
        margin-top: 5px;
        margin-right: auto;
        background: white;
      }
      #examples {
        overflow-x: scroll;
        margin: 5px;
        background: gray;
        height: 173px;
      }
      #examplesSpan {
        display: block;
        margin-left: 5px;
        margin-top: 5px;
        font-size: 14px;
        font-weight: bold;
      }
    </style>
    <script type="text/javascript">
      "use strict";
      let areWeHighlighting = false;
      const mnemonics = [
        "ADD",
        "ADDCY",
        "ADDC",
        "AND",
        "CALL",
        "CALL@",
        "COMPARE",
        "COMP",
        "DISABLE",
        "ENABLE",
        "FETCH",
        "INPUT",
        "IN",
        "JUMP",
        "JUMP@",
        "LOAD",
        "OR",
        "OUTPUT",
        "OUT",
        "RETURN",
        "RET",
        "RETURNI",
        "RETI",
        "RL",
        "RR",
        "SL0",
        "SL1",
        "SLA",
        "SLX",
        "SR0",
        "SR1",
        "SRA",
        "SRX",
        "STORE",
        "SUB",
        "SUBCY",
        "SUBC",
        "TEST",
        "XOR",
        "INST",
        "LOAD&RETURN",
        "HWBUILD",
        "STAR",
        "OUTPUTK",
        "REGBANK",
        "TESTCY",
        "TESTC",
        "COMPARECY",
        "COMPCY",
      ];
      const preprocessor = [
        "ADDRESS",
        "ORG",
        "VHDL",
        "EQU",
        "NAMEREG",
        "CONSTANT",
      ];
      let registers = [new Uint8Array(16), new Uint8Array(16)],
        flagZ = [0, 0],
        flagC = [0, 0],
        flagIE = 1,
        output = new Uint8Array(256),
        memory = new Uint8Array(256),
        regbank = 0,
        callStack = [];
      let simulationThread;
      function displayRegistersAndFlags() {
        for (let i = 0; i < 2; i++)
          for (let j = 0; j < 16; j++) {
            const tableCell = document.getElementById(
              "register_" +
                String.fromCharCode("A".charCodeAt(0) + i) +
                "_s" +
                j.toString(16)
            );
            if (
              tableCell.innerHTML !== formatAsByte(registers[i][j]) &&
              registers[i][j]
            )
              tableCell.className = "changed";
            else if (tableCell.innerHTML !== formatAsByte(registers[i][j]))
              tableCell.className = "turning_off";
            else if (tableCell.innerHTML === "00")
              tableCell.className = "inactive";
            else tableCell.className = "active";
            tableCell.innerHTML = formatAsByte(registers[i][j]);
          }
        if (
          document.getElementById("flag_A_Z").innerHTML !==
            flagZ[0].toString() &&
          flagZ[0]
        )
          document.getElementById("flag_A_Z").className = "changed";
        else if (
          document.getElementById("flag_A_Z").innerHTML !== flagZ[0].toString()
        )
          document.getElementById("flag_A_Z").className = "turning_off";
        else if (flagZ[0] === 0)
          document.getElementById("flag_A_Z").className = "inactive";
        else document.getElementById("flag_A_Z").className = "active";
        document.getElementById("flag_A_Z").innerHTML = flagZ[0];
        if (
          document.getElementById("flag_B_Z").innerHTML !==
            flagZ[1].toString() &&
          flagZ[1]
        )
          document.getElementById("flag_B_Z").className = "changed";
        else if (
          document.getElementById("flag_B_Z").innerHTML !== flagZ[1].toString()
        )
          document.getElementById("flag_B_Z").className = "turning_off";
        else if (flagZ[1] === 0)
          document.getElementById("flag_B_Z").className = "inactive";
        else document.getElementById("flag_B_Z").className = "active";
        document.getElementById("flag_B_Z").innerHTML = flagZ[1];
        if (
          document.getElementById("flag_A_C").innerHTML !==
            flagC[0].toString() &&
          flagC[0]
        )
          document.getElementById("flag_A_C").className = "changed";
        else if (
          document.getElementById("flag_A_C").innerHTML !== flagC[0].toString()
        )
          document.getElementById("flag_A_C").className = "turning_off";
        else if (flagC[0] === 0)
          document.getElementById("flag_A_C").className = "inactive";
        else document.getElementById("flag_A_C").className = "active";
        document.getElementById("flag_A_C").innerHTML = flagC[0];
        if (
          document.getElementById("flag_B_C").innerHTML !==
            flagC[1].toString() &&
          flagC[1]
        )
          document.getElementById("flag_B_C").className = "changed";
        else if (
          document.getElementById("flag_B_C").innerHTML !== flagC[1].toString()
        )
          document.getElementById("flag_B_C").className = "turning_off";
        else if (flagC[1] === 0)
          document.getElementById("flag_B_C").className = "inactive";
        else document.getElementById("flag_B_C").className = "active";
        document.getElementById("flag_B_C").innerHTML = flagC[1];
        const regbank_a = document.getElementsByClassName("regbank_a");
        const regbank_b = document.getElementsByClassName("regbank_b");
        for (const element of regbank_a)
          element.style.fontStyle = regbank == 0 ? "normal" : "italic";
        for (const element of regbank_b)
          element.style.fontStyle = regbank == 1 ? "normal" : "italic";
        if (
          document.getElementById("interrupt_flag").innerHTML !==
            flagIE.toString() &&
          flagIE
        )
          document.getElementById("interrupt_flag").className = "changed";
        else if (
          document.getElementById("interrupt_flag").innerHTML !==
          flagIE.toString()
        )
          document.getElementById("interrupt_flag").className = "turning_off";
        else if (flagIE === 0)
          document.getElementById("interrupt_flag").className = "inactive";
        else document.getElementById("interrupt_flag").className = "active";
        document.getElementById("interrupt_flag").innerHTML = flagIE;
      }
      function highlightToken(token) {
        if (token[0] === ";") return `<span class="comment">${token}</span>`;
        for (const mnemonic of mnemonics)
          if (
            RegExp("^" + mnemonic + "$", "i").test(token) ||
            /^interrupt$/i.test(token)
          )
            return `<span class="mnemonic">${token}</span>`;
        for (const directive of preprocessor)
          if (RegExp("^" + directive + "$", "i").test(token))
            return `<span class="directive">${token}</span>`;
        if (/^s(\d|[a-f])$/i.test(token))
          return `<span class="register">${token}</span>`;
        if (/^N?[CZAB]$/i.test(token))
          return `<span class="flag">${token}</span>`;
        if (/:$/.test(token)) return `<span class="label">${token}</span>`;
        if (token[0] === '"') return `<span class="string">${token}</span>`;
        if (
          /^(\d|[a-f])+$/i.test(token) ||
          /\'d$/.test(token) ||
          /\'b$/.test(token)
        )
          return `<span class="number">${token}</span>`;
        return token;
      }
      function syntaxHighlihter(/*edit*/) {
        //"edit" should contain the
        //cursor position, but that
        //seems not to work.
        if (areWeHighlighting) return;
        areWeHighlighting = true;
        const assemblyCodeDiv = document.getElementById("assemblyCode");
        const assemblyCode = assemblyCodeDiv.innerText
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        //const start=edit.selectionStart,
        //  end=edit.selectionEnd; //Cursor position.
        let areWeInAString = false;
        let areWeInAComment = false;
        let currentToken = "";
        let highlightedText = "";
        for (let i = 0; i < assemblyCode.length; i++) {
          if (assemblyCode[i] === ";" && !areWeInAString) {
            highlightedText += highlightToken(currentToken);
            currentToken = ";";
            areWeInAComment = true;
            continue;
          }
          if (areWeInAComment && assemblyCode[i] !== "\n") {
            currentToken += assemblyCode[i];
            continue;
          }
          if (assemblyCode[i] === "\n") {
            areWeInAString = false;
            areWeInAComment = false;
            highlightedText += highlightToken(currentToken) + "<br/>";
            currentToken = "";
            continue;
          }
          if (assemblyCode[i] === ":" && !areWeInAString) {
            highlightedText += highlightToken(currentToken + assemblyCode[i]);
            currentToken = "";
            continue;
          }
          if (
            (assemblyCode[i] === " " ||
              assemblyCode[i] === "\t" ||
              assemblyCode[i] === "," ||
              assemblyCode[i] === "+" ||
              assemblyCode[i] === "-" ||
              assemblyCode[i] === "*" ||
              assemblyCode[i] === "/" ||
              assemblyCode[i] === "^") &&
            !areWeInAString
          ) {
            highlightedText += highlightToken(currentToken) + assemblyCode[i];
            currentToken = "";
            continue;
          }
          if (assemblyCode[i] === '"' && !areWeInAString) {
            highlightedText += highlightToken(currentToken);
            currentToken = '"';
            areWeInAString = true;
            continue;
          }
          if (
            (assemblyCode[i] === "(" ||
              assemblyCode[i] === ")" ||
              assemblyCode[i] === "[" ||
              assemblyCode[i] === "]" ||
              assemblyCode[i] === "{" ||
              assemblyCode[i] === "}") &&
            !areWeInAString
          ) {
            highlightedText +=
              highlightToken(currentToken) +
              '<span class="parenthesis">' +
              assemblyCode[i] +
              "</span>";
            currentToken = "";
            continue;
          }
          if (assemblyCode[i] !== '"') {
            currentToken += assemblyCode[i];
            continue;
          }
          if (assemblyCode[i] === '"' && areWeInAString) {
            highlightedText += highlightToken(currentToken + '"');
            currentToken = "";
            areWeInAString = false;
          }
        }
        highlightedText += highlightToken(currentToken);
        assemblyCodeDiv.innerHTML = highlightedText;
        //The following code is supposed to move the cursor to the correct
        //position, but it doesn't work.
        /*
        const range=document.createRange();
        range.setStart(assemblyCodeDiv,start);
        range.setEnd(assemblyCodeDiv,end);
        const selection=window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        */
        setUpLineNumbers();
        areWeHighlighting = false;
      }
      function setUpLineNumbers() {
        const assemblyCode = document.getElementById("assemblyCode").innerText;
        const numberOfLines = Math.max(
          (assemblyCode.match(/\n/g) || []).length,
          1
        );
        let lineNumbersHTML = "";
        for (let i = 1; i <= numberOfLines; i++)
          lineNumbersHTML += i + ".<br/>";
        document.getElementById("lineNumbers").innerHTML = lineNumbersHTML;
      }
      function setupLayout() {
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight; //Modern browsers execute JavaScript so fast that calling "window.innerWidth" multiple times within a function leads to a race condition.
        if (windowWidth < 500)
          document.getElementsByTagName("main")[0].style.left = 8 + "px";
        else
          document.getElementsByTagName("main")[0].style.left =
            windowWidth / 2 - 500 / 2 + "px";
        if (windowHeight < 400) {
          document.getElementById("buttons").style.top =
            windowHeight + 200 + 3 * 4 + "px";
          document.getElementById("divWithMachineCode").style.top =
            windowHeight + 4 * 4 + 20 + 200 + "px";
          document.getElementById("simulationButtons").style.top =
            2 * windowHeight + 3 * 4 + 30 + 200 + "px";
          document.getElementsByTagName("footer")[0].style.top =
            65 + 4 + 2 * 50 + 3 * windowHeight + 200 + "px";
          document.getElementById("divWithExamples").style.top =
            windowHeight + 4 + "px";
          document.getElementById("simulationResults").style.top =
            windowHeight * 2 + 200 + 65 + 50 - 30 + "px";
        } else {
          document.getElementById("divWithExamples").style.top = 410 + "px";
          document.getElementById("buttons").style.top =
            400 + 210 + 3 * 4 + "px";
          document.getElementById("divWithMachineCode").style.top =
            450 + 210 + "px";
          document.getElementById("simulationButtons").style.top =
            855 + 210 + "px";
          document.getElementById("simulationResults").style.top =
            910 + 210 + "px";
          document.getElementsByTagName("footer")[0].style.top =
            1380 + 210 + "px";
        }
        const examples = document.getElementsByClassName("exampleCodeLink");
        let left = 8;
        for (const example of examples) {
          example.style.left = left + "px";
          left += 130;
        }
      }
      let machineCode = [];
      for (let i = 0; i < 4096; i++)
        machineCode.push({ hex: "00000", line: 0 });
      let PC = 0;
      function formatAsAddress(n) {
        let ret = Math.round(n).toString(16);
        if (Math.round(n) >= 4096 || Math.round(n) < 0) {
          alert(
            "Some part of the compiler tried to format the number " +
              n +
              " as an address, which makes no sense."
          );
          return "fff";
        }
        while (ret.length < 3) ret = "0" + ret;
        return ret;
      }
      function drawTable() {
        let tableHTML = `
        <table id="machineCode">
           <tr>
             <th colspan=\"4\">Machine Code</th>
           </tr>
           <tr>
             <th>PC</th>
             <th>Address</th>
             <th>Directive</th>
             <th>Line</th>
           </tr>
        `;
        for (let i = 0; i < machineCode.length; i++)
          tableHTML += `
            <tr>
              <td id="PC_label_${formatAsAddress(i)}">${
            PC === i ? "-&gt;" : " "
          }</td>
              <td>${formatAsAddress(i)}</td>
              <td>${machineCode[i].hex}</td>
              <td>${machineCode[i].line}</td>
            </tr>
          `;
        tableHTML += "</table>";
        document.getElementById("divWithMachineCode").innerHTML = tableHTML;
        let registersTable = `
<table>
  <tr>
    <th>Registers</th>
        `;
        for (let i = 0; i < 16; i++)
          registersTable += "<th>s" + i.toString(16) + "</th>";
        registersTable += '</tr><tr class="regbank_a"><th>REGBANK A</th>';
        for (let i = 0; i < 16; i++)
          registersTable +=
            '<td id="register_A_s' + i.toString(16) + '">00</td>';
        registersTable += '</tr><tr class="regbank_b"><th>REGBANK B</th>';
        for (let i = 0; i < 16; i++)
          registersTable +=
            '<td id="register_B_s' + i.toString(16) + '">00</td>';
        registersTable += "</tr></table>";
        let flagsTable = `
        <table>
          <tr>
            <th>Flags</th>
            <th>Zero (Z)</th>
            <th>Carry (C)</th>
            <th>Interrupt Enabled (IE)</th>
          </tr>
          <tr class="regbank_a">
            <th>REGBANK A</th>
            <td id="flag_A_Z">0</td>
            <td id="flag_A_C">0</td>
            <td id="interrupt_flag" rowspan="2">1</td>
          </tr>
          <tr class="regbank_b">
            <th>REGBANK B</th>
            <td id="flag_B_Z">0</td>
            <td id="flag_B_C">0</td>
          </tr>
        </table>
        <div style="text-align: center; font-family: Arial;">
        <b style="background: #FF7777; padding-left: 2px; padding-right:2px;">
        NOTE</b>:
        I have good reasons to think the emulation of flags is unrealistic,
        especially when it comes to <code>REGBANK</code>s.</div>`;
        let inputOutputTable = `
<table>
  <tr>
    <th>Address</th>
    <th>Input</th>
    <th>Output</th>
    <th>Memory</th>
  </tr>
        `;
        for (let i = 0; i < 256; i++)
          inputOutputTable +=
            "<tr><th>" +
            formatAsByte(i) +
            '</th><td><input id="input_' +
            formatAsByte(i) +
            '" value="00"></td><td id="output_' +
            formatAsByte(i) +
            '">00</td><td id="memory_' +
            formatAsByte(i) +
            '">00</td></tr>';
        inputOutputTable += "</table>";
        document.getElementById("simulationResults").innerHTML =
          registersTable + flagsTable + inputOutputTable;
      }
      function displayOutput() {
        for (let i = 0; i < 256; i++)
          document.getElementById(
            "output_" + formatAsByte(i)
          ).innerHTML = formatAsByte(output[i]);
      }
      function fetchExample(exampleName) {
        fetch(
          "https://raw.githubusercontent.com/FlatAssembler/PicoBlaze_Simulator_in_JS/master/" +
            exampleName
        )
          .then((response) => {
            if (!response.ok) throw new Error("Error " + response.status);
            else return response.text();
          })
          .then((text) => {
            document.getElementById("assemblyCode").innerHTML = text;
            setUpLineNumbers();
          })
          .catch((error) =>
            alert(
              "Fetching the example code from GitHub unsuccessful! " + error
            )
          );
      }
    </script>
    <script src="TreeNode.js"></script>
    <script src="tokenizer.js"></script>
    <script src="parser.js"></script>
    <script src="preprocessor.js"></script>
    <script src="assembler.js"></script>
    <script src="simulator.js"></script>
  </head>
  <body>
    <header>
      <h1>PicoBlaze Simulator</h1>
      Made by Teo Samar&#382;ija.
    </header>
    <main>
      <div id="lineNumbers">1.</div>
      <pre id="assemblyCode" contenteditable="true">
;Insert assembly here...
</pre
      >
      <div id="divWithExamples">
        <span id="examplesSpan">Examples:</span>
        <div id="examples">
          <div class="exampleCodeLink" onclick="fetchExample('fibonacci.psm')">
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/FibonacciRabbit.svg/220px-FibonacciRabbit.svg.png"
            />Fibonacci Sequence
          </div>
          <div class="exampleCodeLink" onclick="fetchExample('gray.psm')">
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Gray_code_tesseract.svg/220px-Gray_code_tesseract.svg.png"
            />Gray Code
          </div>
        </div>
      </div>
      <div id="buttons">
        <button id="highlightButton">Highlight Assembly</button>
        <button id="assembleButton">Assemble</button>
      </div>
      <div id="divWithMachineCode">
        <span id="warningAboutJavaScript"
          >Your browser doesn't seem to support advanced JavaScript!</span
        >
      </div>
      <div id="simulationButtons">
        <button id="playPauseButton">
          <img
            src="play.svg"
            alt="play"
            id="playImage"
            style="display: inline"
          />
          <img
            src="pause.svg"
            alt="pause"
            id="pauseImage"
            style="display: none"
          />
          <span class="tooltip">Play/Pause</span>
          <!--Didn't know modern browsers don't display alts automatically
              when you hover over an image.-->
        </button>
        <button id="fastForwardButton">
          <img src="fastForward.svg" alt="Fast Forward" />
          <span class="tooltip">Fast Forward</span>
        </button>
        <button id="singleStepButton">
          <img src="singleStep.svg" alt="Single Step" />
          <span class="tooltip">Single Step</span>
        </button>
        <button id="stopButton">
          <svg width="30" height="30" alt="stop">
            <defs>
              <radialGradient id="redGradient">
                <stop offset="0%" stop-color="rgb(64,0,0)" />
                <stop offset="75%" stop-color="black" />
              </radialGradient>
            </defs>
            <polygon points="0,0 30,0 30,30 0,30" fill="url(#redGradient)" />
          </svg>
          <span class="tooltip">Stop</span>
        </button>
      </div>
      <div id="simulationResults"></div>
    </main>
    <footer>
      Not affiliated with
      <a
        href="https://www.xilinx.com/products/intellectual-property/picoblaze.html"
        >PicoBlaze</a
      >. If you want to contribute,
      <a href="https://github.com/FlatAssembler/PicoBlaze_Simulator_in_JS"
        >fork me on GitHub</a
      >. If you would like to know more about me, visit my
      <a href="https://flatassembler.github.io/">homepage</a>.
    </footer>
    <script type="text/javascript">
      "use strict";
      //For now, attempting to highlight code as the user is typing is worse
      //than useless, because it moves the cursor to the beginning.
      /*
    document.getElementById("assemblyCode").
             oninput=syntaxHighlihter;
    */
      setUpLineNumbers();
      document.getElementById("assemblyCode").oninput = setUpLineNumbers;
      document.getElementById("assemblyCode").onscroll = () => {
        document
          .getElementById("lineNumbers")
          .scrollTo(0, document.getElementById("assemblyCode").scrollTop);
      };
      document.getElementById("highlightButton").onclick = syntaxHighlihter;
      document.getElementById("assembleButton").onclick = () => {
        const assembly = document.getElementById("assemblyCode").innerText;

        let tokenized;
        try {
          tokenized = tokenize(assembly);
        } catch (error) {
          alert("Internal compiler error in the tokenizer: " + error.message);
          return;
        }
        let resultOfTokenizing = "[";
        for (let i = 0; i < tokenized.length; i++) {
          const token = tokenized[i];
          if (token.text == "\n") resultOfTokenizing += '"\\n"';
          else resultOfTokenizing += '"' + token.text + '"';
          if (i != tokenized.length - 1) resultOfTokenizing += ",";
        }
        resultOfTokenizing += "]";
        console.log("Result of tokenizing: ", resultOfTokenizing);
        let parsed;
        try {
          parsed = parse(tokenized);
        } catch (error) {
          alert("Internal compiler error in the parser: " + error.message);
        }
        console.log("Result of parsing: ", parsed.getLispExpression());
        let context;
        try {
          context = makeCompilationContext(parsed);
        } catch (error) {
          alert(
            "Internal compiler error in the preprocessor: " + error.message
          );
        }
        console.log("Result of preprocessing: ", context);
        try {
          assemble(parsed, context);
        } catch {
          alert("Internal assembler error: " + error.message);
        }
        drawTable();
        stopSimulation();
      };
      function stopSimulation() {
        document.getElementById("fastForwardButton").disabled = false;
        document.getElementById("singleStepButton").disabled = false;
        if (playing) clearInterval(simulationThread);
        document.getElementById("PC_label_" + formatAsAddress(PC)).innerHTML =
          "";
        PC = 0;
        document.getElementById("PC_label_000").innerHTML = "->";
        playing = false;
        document.getElementById("playImage").style.display = "inline";
        document.getElementById("pauseImage").style.display = "none";
        for (let i = 0; i < 256; i++) output[i] = 0;
        for (let i = 0; i < 16; i++) registers[0][i] = registers[1][i] = 0;
        flagZ = [0, 0];
        flagC = [0, 0];
        callStack = [];
        regbank = 0;
        flagIE = 1;
        displayRegistersAndFlags();
        displayOutput();
      }
      setupLayout();
      window.onresize = setupLayout;
      drawTable();
      displayRegistersAndFlags();
      let playing = false;
      function onPlayPauseButton() {
        playing = !playing;
        if (!playing) {
          clearInterval(simulationThread);
          document.getElementById("fastForwardButton").disabled = false;
          document.getElementById("singleStepButton").disabled = false;
          document.getElementById("playImage").style.display = "inline";
          document.getElementById("pauseImage").style.display = "none";
        } else {
          simulationThread = setInterval(simulateOneInstruction, 500);
          document.getElementById("fastForwardButton").disabled = true;
          document.getElementById("singleStepButton").disabled = true;
          document.getElementById("playImage").style.display = "none";
          document.getElementById("pauseImage").style.display = "inline";
        }
      }
      function onSingleStepButton() {
        if (playing) return;
        simulateOneInstruction();
      }
      function fastForward() {
        playing = true;
        document.getElementById("fastForwardButton").disabled = true;
        document.getElementById("singleStepButton").disabled = true;
        simulationThread = setInterval(simulateOneInstruction, 0);
        document.getElementById("playImage").style.display = "none";
        document.getElementById("pauseImage").style.display = "inline";
      }
      document.getElementById("playPauseButton").onclick = onPlayPauseButton;
      document.getElementById("stopButton").onclick = stopSimulation;
      document.getElementById("singleStepButton").onclick = onSingleStepButton;
      document.getElementById("fastForwardButton").onclick = fastForward;
    </script>
  </body>
</html>
